async function confirmRepost() {
  const userId = currentUser.uid;
  const campaignId = id;

  // Prevent duplicate repost
  const dupes = await db.collection("reposts")
    .where("userId", "==", userId)
    .where("campaignId", "==", campaignId)
    .get();
  if (!dupes.empty) {
    alert("âŒ You've already reposted this track.");
    return;
  }

  // Limit to 10 reposts per 12 hours
  const twelveHoursAgo = new Date(Date.now() - 12 * 60 * 60 * 1000);
  const recent = await db.collection("reposts")
    .where("userId", "==", userId)
    .where("timestamp", ">", twelveHoursAgo)
    .get();
  if (recent.size >= 10) {
    alert("ğŸš« Youâ€™ve hit your 10 reposts for this 12-hour window.");
    return;
  }

  // Get user data (including followers)
  const userRef = db.collection("users").doc(userId);
  const userSnap = await userRef.get();
  const userData = userSnap.data();
  const followers = userData.soundcloud?.followers || 0;
  const repostCredits = Math.floor(followers / 100); // 100 followers = +1 credit

  const earnedCredits = repostCredits + (liked ? 1 : 0) + (comment ? 2 : 0);

  if (earnedCredits <= 0) {
    alert("âŒ You must like, comment, or have followers to earn credits.");
    return;
  }

  const ownerRef = db.collection("users").doc(campaignData.userId);

  const batch = db.batch();

  // Log repost
  const repostRef = db.collection("reposts").doc();
  batch.set(repostRef, {
    userId,
    campaignId,
    trackUrl: campaignData.trackUrl,
    liked,
    comment,
    timestamp: new Date(),
    prompted: false
  });

  // Update your credits
  batch.update(userRef, {
    credits: firebase.firestore.FieldValue.increment(earnedCredits)
  });

  // Deduct from campaign owner
  batch.update(ownerRef, {
    credits: firebase.firestore.FieldValue.increment(-earnedCredits)
  });

  // Log transaction
  const logRef = db.collection("transactions").doc();
  batch.set(logRef, {
    userId,
    type: "earned",
    amount: earnedCredits,
    reason: `Reposted: ${campaignData.title}`,
    timestamp: new Date()
  });

  // ğŸ… Count total reposts by user
  const allReposts = await db.collection("reposts")
    .where("userId", "==", userId)
    .get();
  const totalReposts = allReposts.size + 1;

  // ğŸ… Assign badge
  let badge = { name: "Rookie", level: 1, emoji: "ğŸŸ¢" };
  if (totalReposts >= 100) badge = { name: "Kingpin", level: 4, emoji: "ğŸ‘‘" };
  else if (totalReposts >= 50) badge = { name: "Track Titan", level: 3, emoji: "ğŸ”´" };
  else if (totalReposts >= 10) badge = { name: "Signal Booster", level: 2, emoji: "ğŸ”µ" };

  // ğŸ… Save badge to user profile
  batch.update(userRef, { badge });

  // Commit it all
  await batch.commit();

  alert(`âœ… Repost complete! You earned ${earnedCredits} credits and your badge has been updated.`);
  window.location.href = "dashboard.html";
}


