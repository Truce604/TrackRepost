<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Repost Campaigns - TrackRepost</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
  <script src="/js/firebaseConfig.js"></script>
  <script>
    firebase.initializeApp(window.firebaseConfig);
  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f9f9f9;
      color: #333;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #2a2a2a;
      color: white;
      text-align: center;
      padding: 20px 0;
    }
    h1 {
      font-size: 36px;
      margin: 0;
    }
    .container {
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .track-item {
      border: 1px solid #ddd;
      padding: 20px;
      margin: 10px 0;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    iframe {
      width: 100%;
      height: 166px;
      border-radius: 10px;
    }
    .track-actions {
      margin-top: 10px;
    }
    .track-actions label {
      display: block;
      margin: 5px 0;
      font-size: 15px;
    }
    textarea {
      width: 100%;
      height: 50px;
      border-radius: 5px;
      margin-top: 5px;
      padding: 8px;
      border: 1px solid #ccc;
    }
    .status-message {
      margin-top: 10px;
      font-weight: bold;
      color: #f44336;
    }
    button {
      background-color: #4caf50;
      color: white;
      padding: 10px 20px;
      margin-top: 10px;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
    button:hover {
      background-color: #45a049;
    }
    footer {
      background-color: #333;
      color: white;
      text-align: center;
      padding: 10px 0;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üé∂ Available Tracks to Repost</h1>
  </header>

  <main class="container">
    <div id="track-list">Loading campaigns...</div>
  </main>

  <footer>
    <p>¬© 2025 TrackRepost. All Rights Reserved.</p>
  </footer>

  <script>
    const db = firebase.firestore();
    const trackList = document.getElementById("track-list");

    firebase.auth().onAuthStateChanged(async (user) => {
      if (!user) {
        trackList.innerHTML = "<p>‚ùå Please log in to see repostable tracks.</p>";
        return;
      }

      const userRef = db.collection("users").doc(user.uid);
      const userSnap = await userRef.get();
      const userData = userSnap.data();
      const baseReward = Math.floor((userData.soundcloud?.followers || 0) / 100);
      if (baseReward === 0) {
        trackList.innerHTML = "<p>‚ö†Ô∏è You need at least 100 SoundCloud followers to earn credits.</p>";
        return;
      }

      const repostedIds = new Set(
        (await db.collection("reposts").where("userId", "==", user.uid).get()).docs.map(doc => doc.data().campaignId)
      );

      const campaignsSnap = await db.collection("campaigns").get();
      const campaigns = campaignsSnap.docs
        .map(doc => ({ id: doc.id, ...doc.data() }))
        .filter(c => !repostedIds.has(c.id) && c.credits >= baseReward);

      if (campaigns.length === 0) {
        trackList.innerHTML = "<p>üéâ No eligible campaigns available at the moment.</p>";
        return;
      }

      trackList.innerHTML = "";
      for (const c of campaigns) {
        const el = document.createElement("div");
        el.className = "track-item";
        el.innerHTML = `
          <h3>${c.genre}</h3>
          <iframe src="https://w.soundcloud.com/player/?url=${encodeURIComponent(c.trackUrl)}&color=%23ff5500" frameborder="no" scrolling="no"></iframe>
          <div class="track-actions">
            <label><input type="checkbox" class="like" checked /> üíñ Like (+1 credit)</label>
            <label><input type="checkbox" class="follow" checked /> üë£ Follow (+2 credits)</label>
            <label><input type="checkbox" class="comment" /> üí¨ Comment (+2 credits)</label>
            <textarea class="commentText" placeholder="Leave a comment..."></textarea>
            <button>‚úÖ Repost & Earn</button>
            <div class="status-message"></div>
          </div>
        `;

        const like = el.querySelector(".like");
        const follow = el.querySelector(".follow");
        const comment = el.querySelector(".comment");
        const commentText = el.querySelector(".commentText");
        const status = el.querySelector(".status-message");
        const button = el.querySelector("button");

        button.addEventListener("click", async () => {
          let total = baseReward;
          if (like.checked) total += 1;
          if (follow.checked) total += 2;
          if (comment.checked && commentText.value.trim()) total += 2;

          const campaignRef = db.collection("campaigns").doc(c.id);
          const campaignSnap = await campaignRef.get();
          const campaignData = campaignSnap.data();

          if (campaignData.credits < total) {
            status.textContent = "‚ùå Not enough campaign credits.";
            return;
          }

          await db.collection("reposts").doc(`${user.uid}_${c.id}`).set({
            userId: user.uid,
            campaignId: c.id,
            trackUrl: c.trackUrl,
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            prompted: false,
            like: like.checked,
            follow: follow.checked,
            comment: comment.checked,
            commentText: commentText.value
          });

          await userRef.update({ credits: (userData.credits || 0) + total });
          await campaignRef.update({ credits: campaignData.credits - total });

          await db.collection("transactions").add({
            userId: user.uid,
            type: "earned",
            amount: total,
            reason: `Reposted ${c.trackUrl}`,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });

          status.textContent = `‚úÖ Reposted! You earned ${total} credits.`;
          button.disabled = true;
        });

        trackList.appendChild(el);
      }
    });
  </script>
</body>
</html>




