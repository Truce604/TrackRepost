<script>
  const auth = firebase.auth();
  const db = firebase.firestore();

  let currentUser = null;

  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      document.getElementById("creditBalance").textContent = "Please log in.";
      return;
    }

    currentUser = user;

    const userRef = db.collection("users").doc(user.uid);
    const snap = await userRef.get();
    const userData = snap.data();

    document.getElementById("creditBalance").textContent =
      `You currently have ${userData.credits || 0} credits.`;
  });

  document.querySelectorAll(".buy-btn").forEach((button) => {
    button.addEventListener("click", async () => {
      if (!currentUser) {
        alert("Please log in to buy credits.");
        return;
      }

      const credits = parseInt(button.dataset.credits, 10);
      const plan = button.dataset.plan || null;
      const userId = currentUser.uid;

      document.getElementById("status").textContent = "Redirecting to payment...";

      // ✅ Log the payload to console
      console.log("Sending checkout payload:", { credits, userId, plan });

      try {
        const response = await fetch("/api/square/checkout", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ credits, userId, plan }),
        });

        const { checkoutUrl } = await response.json();

        if (checkoutUrl) {
          window.location.href = checkoutUrl;
        } else {
          document.getElementById("status").textContent = "❌ Failed to create checkout session.";
        }
      } catch (err) {
        console.error("❌ Error creating checkout:", err);
        document.getElementById("status").textContent = "❌ Something went wrong. Please try again.";
      }
    });
  });
</script>



